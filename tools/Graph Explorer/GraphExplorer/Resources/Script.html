<!doctype html>
<html>
<head>
    <title>Socratex Graph Explorer</title>

    <style type='text/css'>
        html,
        body {
            font: 10pt arial;
        }

        #mynetwork {
        }
    </style>

    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="text/javascript" src="Config.js?ts=1234567890"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="contextual.theme.css">
    <link rel="stylesheet" type="text/css" href="contextual.css">
    <script src="contextual.js"></script>

    <script type='text/javascript'>

        var network = null;

        function setGraphSize(width, height) {
            document.getElementById('mynetwork').style.width = width + 'px';
            document.getElementById('mynetwork').style.height = height + 'px';
        }

        // The menu system needs an event to get triggered correctly. To do this a 
        // special event is triggered when the menu is opened, and the position and
        // the menu are saved here.
        var contextMenu;
        var contextMenuX, contextMenuY;
        function openMenu(menu) {
            contextMenu = menu;
            var target = document.getElementById('mynetwork');
            target.dispatchEvent(new Event("CreateMenu", {'menu': menu}));
        }

        function draw(nodesAndEdgesInJson, backgroundColor, foregroundColor, showNavigationButtons, allowKeyboardNavigation) {
            // Set the colors of the foreground and background. The colors passed from
            // the application are in conformance with the visual preferences of the
            // user, but you may assign any static value you want for the colors to
            // overrride these choices.
            document.body.style.background = backgroundColor;
            document.body.style.color = foregroundColor;

            // Instantiate our network object.
            var container = document.getElementById('mynetwork');

            // Convert the graph rendering agnostic format to the vis.js format
            var graphNodes = [];
            nodesAndEdgesInJson.Nodes.forEach(n => {
                graphNodes.push(createGraphNode(n));
            });

            var graphEdges = [];
            nodesAndEdgesInJson.Edges.forEach(e => {
                graphEdges.push(createGraphEdge(e));
            });

            data = { nodes: graphNodes, edges: graphEdges };

            var options =
            {
                interaction: {
                    hover: true,
                    selectConnectedEdges: false,
                    navigationButtons: showNavigationButtons,
                    keyboard: allowKeyboardNavigation,
                },
                manipulation: {
                    enabled: false, // true enables adding nodes to the graph
                },
                nodes: {
                    size: 10, // For nodes that do not have specific size or where no value attribute is provided
                    font: { strokeWidth: 2 }, // This is the amount of space around the text in nodes or edges.
                    shape: 'dot',
                    scaling: {
                        min: 10, max: 30,
                        label: { // Make sure font size is in this range.
                            min: 8, max: 24
                        }
                    }
                },
                edges: {
                    arrows: "to",
                    shadow: false,
                    smooth: true,
                    scaling: {
                        min: 2, 'max': 12, 'label': { 'enabled': true, 'min': 9, 'max': 14 }
                    }
                }
            }

            network = new vis.Network(container, data, options);

            network.on('oncontext', (params) => {
                params.event.preventDefault();
                contextMenuX = params.event.clientX;
                contextMenuY = params.event.clientY;

                // Find out if we are getting context for a node, an edge or the surface
                var node = network.getNodeAt(params.pointer.DOM);
                if (node) {
                    // hovering over a node:
                    window.chrome.webview.postMessage({ 'contextOverNode': node });
                }
                else {
                    // Check if it is an edge:
                    var edge = network.getEdgeAt(params.pointer.DOM);
                    if (edge) {
                        window.chrome.webview.postMessage({ 'contextOverEdge': edge });
                    }
                }
            }, false);

            // Special event handlers to manage the context menu
            mynetwork.addEventListener("CreateMenu", (params) => {
                console.log("In CreateMenu");

                params.clientX = contextMenuX;
                params.clientY = contextMenuY;
                params.target = mynetwork

                new Contextual(contextMenu)
            });

            // Wire in the messaging so that the C# is notified of clicking in
            // nodes or edges.
            network.on('selectNode', function (params) {
                window.chrome.webview.postMessage({ 'selectedNodeId': params.nodes[0] });
            });

            network.on('selectEdge', function (params) {
                window.chrome.webview.postMessage({ 'selectedEdgeId': params.edges[0] });
            });
        }
    </script>
</head>

<body >
    <div id='mynetwork' >
    </div >
</body >

</html >
